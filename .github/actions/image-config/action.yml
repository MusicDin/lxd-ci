name: Upload Image
description: Composite action for uploading built images

inputs:
  target:
    description: Directory where config.yaml is generated
    required: true
  release:
    description: Image release name
    required: true
  image_release_aliases:
    description: Mapping of the release name and its aliases
    default: ""
  image_release_title:
    description: Image release title
    default: ""
  image_requirements:
    description: Image requirements
    default: ""

runs:
  using: composite
  steps:
    - name: Generate config.yaml
      shell: bash
      run: |
        CONFIG="${{ inputs.target }}/config.yaml"
        RELEASE=${{ inputs.release }}
        RELEASE_ALIASES="${{ inputs.image_release_aliases }}"
        RELEASE_TITLE="${{ inputs.image_release_title }}"
        REQUIREMENTS="${{ inputs.image_requirements }}"

        mkdir -p "${{ inputs.target }}"

        if [ -n "${RELEASE_TITLE}" ]; then
            echo "release_title: '${RELEASE_TITLE}'" >> "${CONFIG}"
        fi

        while IFS='=' read -r key alias; do
            key=$(echo "${key}" | tr -d ' ')
            alias=$(echo "${alias}" | tr -d ' ')

            if [ "${key}" = "${RELEASE}" ] && [ -n "${alias}" ]; then
                echo "release_alias: ${alias}" >> "${CONFIG}"
                break
            fi
        done <<< "${RELEASE_ALIASES}"

        if [ -n "${REQUIREMENTS}" ]; then
            echo "requirements:" >> "${CONFIG}"

            while IFS='=' read -r key val; do
                key=$(echo "${key}" | tr -d ' ')
                val=$(echo "${val}" | tr -d ' ')

                if [ -n "${key}" ] && [ -n "${val}" ]; then
                    echo "  ${key}: ${val}" >> "${CONFIG}"
                fi
            done <<< "${REQUIREMENTS}"
        fi

        cat "${CONFIG}" || true
