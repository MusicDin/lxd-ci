name: Upload Image
description: Composite action for uploading built images

inputs:
  target:
    description: Directory where config.yaml is generated
    required: true
  release:
    description: Image release
    required: true
  image_release_mapper:
    description: Mapping of the release and its aliases
    default: ""
  image_title:
    description: Image title
    default: ""
  image_requirements:
    description: Image requirements
    default: ""

runs:
  using: composite
  steps:
    - name: Generate config.yml
      shell: bash
      run: |
        CONFIG="${{ inputs.target }}/config.yml"
        RELEASE=${{ inputs.release }}
        RELEASE_MAPPER="${{ inputs.image_release_mapper }}"
        DISTRO_TITLE="${{ inputs.image_title }}"
        REQUIREMENTS="${{ inputs.image_requirements }}"

        # Ensure directory config's exists.
        mkdir -p "${{ inputs.target }}"

        # Image title.
        if [ -n "${DISTRO_TITLE}" ]; then
            echo "distro_title: '${DISTRO_TITLE}'" >> "${config}"
        fi

        # Add release aliases.
        while IFS='=' read -r key alias; do
            key=$(echo "${key}" | tr -d ' ')
            alias=$(echo "${alias}" | tr -d ' ')

            if [ "${key}" == "${RELEASE}" ] || [ -n "${alias}" ]; then
                echo "release_alias: ${alias}" >> config.yml
                break
            fi
        done <<< "${RELEASE_MAPPER}"

        # Build requirements.
        if [ -n "${REQUIREMENTS}" ]; then
            echo "requirements:" >> "${config}"

            while IFS='=' read -r key val; do
                key=$(echo "${key}" | tr -d ' ')
                val=$(echo "${val}" | tr -d ' ')

                if [ -n "${key}" ] && [ -n "${val}" ]; then
                    echo "  ${key}: ${val}" >> "${config}"
                fi
            done <<< "${REQUIREMENTS}"
        fi

        cat "${config}"
